"use strict";var e=require("electron"),i=require("child_process"),t=require("os");require("fs");var o=require("path"),a=require("./playable-adapter-core-21b6cdfc.js");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=r(i),d=r(t);const{exec:c,execSync:l}=n.default;var s={run:function(e,i){return c(e,(function(e,t,o){i&&i(e,t,o)}))},runSync:function(e){try{return{data:l(e).toString(),err:null,stderr:null}}catch(e){return{data:null,err:e.stderr.toString(),stderr:e.stderr.toString()}}}};const p="playable-ads-adapter",u=()=>{const e=Editor.Project.path,i="/build",t={buildPlatform:"web-mobile",exportChannels:["AppLovin","Facebook","Google","IronSource","Liftoff","Mintegral","Moloco","Pangle","Tiktok","Unity"],orientation:"auto",injectOptions:{AppLovin:{head:"<script>function redirectStore(){mraid.open()}<\/script>",body:"",sdkScript:""},Facebook:{head:"",body:"<script>function redirectStore(){FbPlayableAd.onCTAClick()}<\/script>",sdkScript:""},Google:{head:"<meta name='ad.size' content=\"width=320,height=480\" >",sdkScript:"",body:"<script>var clickTag='';var android='';function setStoreUrl(iosUrl, androidUrl){clickTag=iosUrl;android=androidUrl;if(/android/i.test(navigator.userAgent)){clickTag=android}};function redirectStore(){window.open(clickTag)}<\/script>"},IronSource:{head:"<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>",body:'<script>window.addEventListener("load", function(){(dapi.isReady()) ? onReadyCallback() : dapi.addEventListener("ready", onReadyCallback);}); function onReadyCallback(){dapi.removeEventListener("ready", onReadyCallback);let isAudioEnabled = !!dapi.getAudioVolume();if(dapi.isViewable()){adVisibleCallback({isViewable: true});} dapi.addEventListener("viewableChange", adVisibleCallback);dapi.addEventListener("adResized", adResizeCallback);dapi.addEventListener("audioVolumeChange",audioVolumeChangeCallback);} function startGame() {dapi.getScreenSize()};function pauseGame(){}; function adVisibleCallback(event){if(event.isViewable){screenSize = dapi.getScreenSize();startGame();}else{pauseGame();}}function adResizeCallback(event){screenSize = event;console.log("ad was resized width " + event.width + " height " + event.height);} function redirectStore(){dapi.openStoreUrl()};function audioVolumeChangeCallback(e){let o=!!e;var n=cc.director.getScene().getComponentsInChildren(cc.AudioSourceComponent);for(let t=0;t<n.length;t++){let l=n[t];l.volume=o?e:0}}<\/script>',sdkScript:""},Liftoff:{head:"",body:"<script>function redirectStore(){mraid.open()}<\/script>",sdkScript:""},Mintegral:{head:"",body:"<script>function redirectStore(){window.install && window.install()} function onGameEnd(){window.gameEnd && window.gameEnd()} function onGameReady(){window.gameReady && window.gameReady()} function gameStart() { console.log('game has started') } function gameClose() { console.log('game closed') }<\/script>",sdkScript:""},Moloco:{head:"",body:"<script>function redirectStore(){FbPlayableAd.onCTAClick()}<\/script>",sdkScript:""},Pangle:{head:"",body:"<script>function redirectStore(){window.openAppStore()}<\/script>",sdkScript:""},Tiktok:{head:"",body:"<script>function redirectStore(){window.playableSDK.openAppStore()}<\/script>",sdkScript:""},Unity:{head:"",body:"<script>if(mraid.getState()==='loading'){mraid.addEventListener('ready',onSdkReady)}else{onSdkReady()}function viewableChangeHandler(viewable){if(viewable){}else{}}function onSdkReady(){mraid.addEventListener('viewableChange',viewableChangeHandler);if(mraid.isViewable()){showMyAd()}}var url='';var android='';function setStoreUrl(iosUrl, androidUrl){url=iosUrl;android=androidUrl;if(/android/i.test(navigator.userAgent)){url=android}};function redirectStore(){mraid.open(url)};function showMyAd(){mraid.open(url)}<\/script>",sdkScript:'<script src="./mraid.js"><\/script>'},Rubeex:{head:"",body:"<script>var clickTag='';var android='';function setStoreUrl(iosUrl, androidUrl){clickTag=iosUrl;android=androidUrl;if(/android/i.test(navigator.userAgent)){clickTag=android}};function redirectStore(){window.open(clickTag)}<\/script>",sdkScript:""}}};let a=t?.buildPlatform??"web-mobile";return{projectRootPath:e,projectBuildPath:i,buildPlatform:a,originPkgPath:o.join(e,i,a),adapterBuildConfig:t}};var g=require("path").join(__dirname+"/3x-121fc8a4.js");const f=e=>new Promise(((i,t)=>{let o=Editor.App.path;const a=(()=>{const e=d.default.platform();return"win32"===e?"WINDOWS":"darwin"===e?"MAC":e.toUpperCase()})();"MAC"===a?o=o.replace("/Resources/app.asar","/MacOS/CocosCreator"):"WINDOWS"===a?(o=(e=>{let i=e;return-1!==i.indexOf("\\")&&(i=i.replace(/\\/g,"/")),i})(o).replace("/resources/app.asar","/CocosCreator.exe"),console.log("cocos builder path",o)):t(`不支持${a}平台构建`);s.run(`${o} --project ${Editor.Project.path} --build "platform=${e}"`,((e,t,o)=>{console.log(e,t,o),i()})).stdout.on("data",(e=>{console.log(e)}))})),b=async e=>{console.log(`${p} 进行预构建处理`),console.log(`${p} 跳过预构建处理`)},m=e=>new Promise((async(i,t)=>{const{projectRootPath:r,projectBuildPath:n,adapterBuildConfig:d}=u(),c=o.join(r,n);console.info(`${p} Start adaptation and export the platform ${e.platform}`);const l=(new Date).getTime(),s=()=>{const e=(new Date).getTime();console.log(`${p} cost ${((e-l)/1e3).toFixed(0)}s`),i(!0)},f=e=>{console.error("适配失败"),t(e)},b={buildFolderPath:c,adapterBuildConfig:{...d,buildPlatform:e.platform}};try{((e,i,t)=>{const{Worker:o}=require("worker_threads");new o(g,{workerData:e}).on("message",(({finished:e,msg:o,event:a})=>{"adapter:finished"!==a?console[a.split(":")[1]](o):e?i():t(o)}))})(b,s,f)}catch(e){console.log("不支持Worker，将开启主线程适配"),await a.exec3xAdapter(b,{mode:"serial"}),s()}}));exports.BUILDER_NAME=p,exports.builder3x=async()=>{try{const{buildPlatform:i,projectRootPath:t,projectBuildPath:a}=u();console.log(`开始构建项目，导出${i}包`);const r=(()=>{const e={buildPlatform:"web-mobile",exportChannels:["AppLovin","Facebook","Google","IronSource","Liftoff","Mintegral","Moloco","Pangle","Tiktok","Unity"],orientation:"auto",injectOptions:{AppLovin:{head:"<script>function redirectStore(){mraid.open()}<\/script>",body:"",sdkScript:""},Facebook:{head:"",body:"<script>function redirectStore(){FbPlayableAd.onCTAClick()}<\/script>",sdkScript:""},Google:{head:"<meta name='ad.size' content=\"width=320,height=480\" >",sdkScript:"",body:"<script>var clickTag='';var android='';function setStoreUrl(iosUrl, androidUrl){clickTag=iosUrl;android=androidUrl;if(/android/i.test(navigator.userAgent)){clickTag=android}};function redirectStore(){window.open(clickTag)}<\/script>"},IronSource:{head:"<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>",body:'<script>window.addEventListener("load", function(){(dapi.isReady()) ? onReadyCallback() : dapi.addEventListener("ready", onReadyCallback);}); function onReadyCallback(){dapi.removeEventListener("ready", onReadyCallback);let isAudioEnabled = !!dapi.getAudioVolume();if(dapi.isViewable()){adVisibleCallback({isViewable: true});} dapi.addEventListener("viewableChange", adVisibleCallback);dapi.addEventListener("adResized", adResizeCallback);dapi.addEventListener("audioVolumeChange",audioVolumeChangeCallback);} function startGame() {dapi.getScreenSize()};function pauseGame(){}; function adVisibleCallback(event){if(event.isViewable){screenSize = dapi.getScreenSize();startGame();}else{pauseGame();}}function adResizeCallback(event){screenSize = event;console.log("ad was resized width " + event.width + " height " + event.height);} function redirectStore(){dapi.openStoreUrl()};function audioVolumeChangeCallback(e){let o=!!e;var n=cc.director.getScene().getComponentsInChildren(cc.AudioSourceComponent);for(let t=0;t<n.length;t++){let l=n[t];l.volume=o?e:0}}<\/script>',sdkScript:""},Liftoff:{head:"",body:"<script>function redirectStore(){mraid.open()}<\/script>",sdkScript:""},Mintegral:{head:"",body:"<script>function redirectStore(){window.install && window.install()} function onGameEnd(){window.gameEnd && window.gameEnd()} function onGameReady(){window.gameReady && window.gameReady()} function gameStart() { console.log('game has started') } function gameClose() { console.log('game closed') }<\/script>",sdkScript:""},Moloco:{head:"",body:"<script>function redirectStore(){FbPlayableAd.onCTAClick()}<\/script>",sdkScript:""},Pangle:{head:"",body:"<script>function redirectStore(){window.openAppStore()}<\/script>",sdkScript:""},Tiktok:{head:"",body:"<script>function redirectStore(){window.playableSDK.openAppStore()}<\/script>",sdkScript:""},Unity:{head:"",body:"<script>if(mraid.getState()==='loading'){mraid.addEventListener('ready',onSdkReady)}else{onSdkReady()}function viewableChangeHandler(viewable){if(viewable){}else{}}function onSdkReady(){mraid.addEventListener('viewableChange',viewableChangeHandler);if(mraid.isViewable()){showMyAd()}}var url='';var android='';function setStoreUrl(iosUrl, androidUrl){url=iosUrl;android=androidUrl;if(/android/i.test(navigator.userAgent)){url=android}};function redirectStore(){mraid.open(url)};function showMyAd(){mraid.open(url)}<\/script>",sdkScript:'<script src="./mraid.js"><\/script>'},Rubeex:{head:"",body:"<script>var clickTag='';var android='';function setStoreUrl(iosUrl, androidUrl){clickTag=iosUrl;android=androidUrl;if(/android/i.test(navigator.userAgent)){clickTag=android}};function redirectStore(){window.open(clickTag)}<\/script>",sdkScript:""}}};return!!e&&(e.skipBuild??!1)})(),n=o.join(t,a);await b(),r||await f(i),await m({platform:i}),e.shell.openPath(n),console.log("构建完成")}catch(e){console.error(e)}},exports.initBuildFinishedEvent=m,exports.initBuildStartEvent=b;
